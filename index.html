<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Confer√™ncia de Comandas</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<!-- BLOQUEIO DE ZOOM -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script>
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('dblclick', e => e.preventDefault());
</script>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#2563eb;
  --success:#16a34a;
  --danger:#dc2626;
  --warning:#f59e0b;
  --bg:#f8fafc;
  --card:#ffffff;
  --text:#0f172a;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:16px;
  font-family:Inter,system-ui,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  touch-action:manipulation;
}

.dashboard{
  max-width:820px;
  margin:auto;
  padding:20px;
  border-radius:16px;
  background:linear-gradient(135deg,var(--primary),#3b82f6);
  color:#fff;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:14px;
}

.card{
  background:rgba(255,255,255,.18);
  border-radius:14px;
  padding:14px;
}

.card strong{
  display:block;
  font-size:2rem;
  margin-top:6px;
}

.ok{background:rgba(22,163,74,.9)}
.alert{background:rgba(220,38,38,.9)}
.info{background:rgba(245,158,11,.9)}

.container{
  max-width:820px;
  margin:20px auto;
}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-size:15px;
  color:#fff;
  margin-bottom:10px;
}

.primary{background:var(--primary)}
.warning{background:var(--warning)}

#reader{
  max-width:340px;
  margin:16px auto;
}

#output{
  background:#fff;
  padding:14px;
  border-radius:12px;
  font-weight:600;
  margin-bottom:14px;
}

table{
  width:100%;
  background:#fff;
  border-radius:14px;
  overflow:hidden;
}

th{
  background:var(--primary);
  color:#fff;
  padding:12px;
}

td{
  padding:12px;
  border-bottom:1px solid #eee;
  text-align:center;
}
</style>
</head>

<body>

<div class="dashboard">
  <h2>üìä Confer√™ncia de Comandas</h2>
  <div class="grid">
    <div class="card">
      <span>Data</span>
      <input type="date" id="dataFiltro">
    </div>
    <div class="card">
      <span>Comandas do dia</span>
      <strong id="qtdDia">0</strong>
    </div>
    <div class="card">
      <span>√öltima contagem</span>
      <strong id="qtdAnterior">0</strong>
    </div>
    <div class="card info" id="statusCard">
      <span>Status</span>
      <strong id="statusTexto">‚Äî</strong>
    </div>
  </div>
</div>

<div class="container">
  <button class="primary" onclick="startScanner()">üì∑ Iniciar Leitura</button>
  <button class="warning" onclick="stopScanner()">‚ùå Fechar C√¢mera</button>

  <div id="reader"></div>
  <div id="output">Aguardando leitura‚Ä¶</div>

  <table>
    <thead>
      <tr><th>Data</th><th>Comanda</th></tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<script>
/* ========= SUPABASE ========= */
const { createClient } = supabase;
const sb = createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* ========= SCANNER ========= */
let scanner=null;
let lock=false;

function startScanner(){
  if(scanner) return;

  scanner = new Html5Qrcode("reader");

  scanner.start(
    { facingMode: "environment" },
    { fps: 20, qrbox: { width: 260, height: 260 } },
    onScan,
    err => {}
  ).catch(err=>{
    document.getElementById("output").innerText="‚ùå Erro c√¢mera: "+err;
  });
}

function stopScanner(){
  if(scanner){
    scanner.stop().then(()=>{
      scanner.clear();
      scanner=null;
    });
  }
}

async function onScan(code){
  if(lock) return;
  lock=true;

  const codigo = code.trim();
  const output = document.getElementById("output");
  output.innerText="‚è≥ Verificando‚Ä¶";

  const { data:existe } = await sb
    .from("comandas")
    .select("id")
    .eq("codigo", codigo)
    .limit(1);

  if(existe.length){
    output.innerText=`‚ö†Ô∏è J√° registrada: ${codigo}`;
    lock=false;
    return;
  }

  await sb.from("comandas").insert({ codigo });
  output.innerText=`‚úÖ Registrada: ${codigo}`;
  lock=false;
  carregar();
}

/* ========= DADOS ========= */
async function carregar(){
  const dataISO=document.getElementById("dataFiltro").value;

  const { data } = await sb
    .from("comandas")
    .select("codigo,created_at");

  let mapa={};

  data.forEach(r=>{
    const d=new Date(r.created_at).toLocaleDateString("pt-BR");
    mapa[d]=(mapa[d]||0)+1;
  });

  const [y,m,d]=dataISO.split("-");
  const dataBR=`${d}/${m}/${y}`;

  const totalDia=mapa[dataBR]||0;

  const anteriores=Object.keys(mapa)
    .map(x=>{
      const [d,m,y]=x.split("/");
      return {br:x,iso:`${y}-${m}-${d}`};
    })
    .filter(x=>x.iso<dataISO)
    .sort((a,b)=>a.iso.localeCompare(b.iso));

  const ultima=anteriores.pop();
  const totalAnterior=ultima?mapa[ultima.br]:0;

  document.getElementById("qtdDia").innerText=totalDia;
  document.getElementById("qtdAnterior").innerText=totalAnterior;

  const status=document.getElementById("statusCard");
  const texto=document.getElementById("statusTexto");

  status.className="card";

  if(!totalAnterior){
    texto.innerText="Sem base";
    status.classList.add("info");
  }else if(totalDia===totalAnterior){
    texto.innerText="‚úî OK";
    status.classList.add("ok");
  }else if(totalDia<totalAnterior){
    texto.innerText=`Faltam ${totalAnterior-totalDia}`;
    status.classList.add("alert");
  }else{
    texto.innerText=`+${totalDia-totalAnterior}`;
    status.classList.add("info");
  }

  const tbody=document.getElementById("lista");
  tbody.innerHTML="";
  data.filter(r=>{
    return new Date(r.created_at).toLocaleDateString("pt-BR")===dataBR;
  }).forEach(r=>{
    tbody.insertAdjacentHTML("beforeend",
      `<tr><td>${dataBR}</td><td>${r.codigo}</td></tr>`
    );
  });
}

/* ========= INIT ========= */
window.onload=()=>{
  document.getElementById("dataFiltro").value=new Date().toISOString().split("T")[0];
  document.getElementById("dataFiltro").addEventListener("change",carregar);
  carregar();
};
</script>
</body>
</html>
